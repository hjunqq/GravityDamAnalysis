# 3.2 插件架构设计

## 3.2.1 分层架构设计

### 整体架构概述

重力坝稳定计算插件采用分层架构设计，遵循领域驱动设计(DDD)原则和依赖倒置原则。整个架构分为五个主要层次，每层都有明确的职责和边界。

```
┌─────────────────────────────────────────┐
│              Revit Layer                │  ← 插件主体和UI集成
├─────────────────────────────────────────┤
│               UI Layer                  │  ← 用户界面和交互
├─────────────────────────────────────────┤
│           Application Layer             │  ← 应用服务和工作流
├─────────────────────────────────────────┤
│         Infrastructure Layer            │  ← Revit数据提取和持久化
├─────────────────────────────────────────┤
│         Domain Layer (Core)             │  ← 核心业务逻辑和实体
└─────────────────────────────────────────┘
```

### Core层：核心实体和业务接口

Core层是整个系统的核心，包含了重力坝分析的业务实体、值对象和领域服务接口。

#### 核心实体 (Entities)

**1. DamEntity - 坝体实体**

```csharp
namespace GravityDamAnalysis.Core.Entities
{
    /// <summary>
    /// 重力坝实体 - 领域核心对象
    /// </summary>
    public class DamEntity
    {
        public Guid Id { get; private set; }
        public string Name { get; private set; }
        
        // 几何属性
        public DamGeometry Geometry { get; private set; }
        
        // 材料属性
        public MaterialProperties MaterialProperties { get; private set; }
        
        // 边界条件
        public BoundaryConditions BoundaryConditions { get; private set; }
        
        // 分析历史
        public List<AnalysisRecord> AnalysisHistory { get; private set; }
        
        // 构造函数
        private DamEntity() { }
        
        public static DamEntity Create(string name, DamGeometry geometry, 
            MaterialProperties materials)
        {
            // 领域验证逻辑
            ValidateGeometry(geometry);
            ValidateMaterials(materials);
            
            return new DamEntity
            {
                Id = Guid.NewGuid(),
                Name = name,
                Geometry = geometry,
                MaterialProperties = materials,
                AnalysisHistory = new List<AnalysisRecord>()
            };
        }
        
        // 领域方法
        public bool IsStableForLoading(AnalysisParameters parameters)
        {
            // 基本稳定性判断逻辑
            return true; // 简化实现
        }
        
        private static void ValidateGeometry(DamGeometry geometry)
        {
            if (geometry.Height <= 0)
                throw new DomainException("坝高必须大于0");
            if (geometry.BaseWidth <= 0)
                throw new DomainException("坝底宽必须大于0");
            if (geometry.BaseWidth < geometry.Height * 0.6)
                throw new DomainException("坝底宽过小，可能不满足稳定要求");
        }
    }
}
```

**2. Profile2D - 二维剖面实体**

```csharp
namespace GravityDamAnalysis.Core.Entities
{
    /// <summary>
    /// 二维剖面实体 - 用于二维分析
    /// </summary>
    public class Profile2D
    {
        public int Index { get; private set; }
        public List<Point2D> ProfilePoints { get; private set; }
        public Profile2DGeometryProperties GeometryProperties { get; private set; }
        
        // 工厂方法
        public static Profile2D CreateFromPoints(int index, List<Point2D> points)
        {
            var profile = new Profile2D
            {
                Index = index,
                ProfilePoints = points.ToList()
            };
            
            // 计算几何属性
            profile.GeometryProperties = CalculateGeometryProperties(points);
            
            return profile;
        }
        
        private static Profile2DGeometryProperties CalculateGeometryProperties(
            List<Point2D> points)
        {
            // 计算面积、重心、几何参数等
            return new Profile2DGeometryProperties
            {
                Area = CalculateArea(points),
                Centroid = CalculateCentroid(points),
                Height = CalculateHeight(points),
                BaseWidth = CalculateBaseWidth(points)
            };
        }
    }
}
```

#### 值对象 (Value Objects)

**1. DamGeometry - 坝体几何**

```csharp
namespace GravityDamAnalysis.Core.ValueObjects
{
    /// <summary>
    /// 坝体几何值对象
    /// </summary>
    public record DamGeometry
    {
        public double Height { get; init; }
        public double BaseWidth { get; init; }
        public double TopWidth { get; init; }
        public double Length { get; init; }
        public double Volume { get; init; }
        public Point3D Centroid { get; init; }
        
        // 计算几何特征
        public double AspectRatio => BaseWidth / Height;
        public double UpstreamSlope => CalculateUpstreamSlope();
        public double DownstreamSlope => CalculateDownstreamSlope();
        
        // 验证方法
        public bool IsValid()
        {
            return Height > 0 && BaseWidth > 0 && Volume > 0;
        }
    }
}
```

**2. MaterialProperties - 材料属性**

```csharp
namespace GravityDamAnalysis.Core.ValueObjects
{
    /// <summary>
    /// 材料属性值对象
    /// </summary>
    public record MaterialProperties
    {
        public double Density { get; init; } = 24.0; // kN/m³
        public double FrictionCoefficient { get; init; } = 0.75;
        public double CohesionStrength { get; init; } = 0.0; // kPa
        public double CompressiveStrength { get; init; } = 30000; // kPa
        public double TensileStrength { get; init; } = 2000; // kPa
        public double ElasticModulus { get; init; } = 30000000; // kPa
        public double PoissonRatio { get; init; } = 0.2;
        
        // 工厂方法
        public static MaterialProperties CreateConcrete()
        {
            return new MaterialProperties
            {
                Density = 24.0,
                FrictionCoefficient = 0.75,
                CompressiveStrength = 30000,
                TensileStrength = 2000
            };
        }
        
        public static MaterialProperties CreateRollerCompactedConcrete()
        {
            return new MaterialProperties
            {
                Density = 23.5,
                FrictionCoefficient = 0.8,
                CompressiveStrength = 25000,
                TensileStrength = 1500
            };
        }
    }
}
```

#### 领域服务接口

**1. IStabilityAnalysisService - 稳定性分析服务**

```csharp
namespace GravityDamAnalysis.Core.Services
{
    /// <summary>
    /// 稳定性分析领域服务接口
    /// </summary>
    public interface IStabilityAnalysisService
    {
        /// <summary>
        /// 执行完整的稳定性分析
        /// </summary>
        Task<StabilityAnalysisResult> AnalyzeStabilityAsync(
            DamEntity damEntity, 
            AnalysisParameters parameters);
        
        /// <summary>
        /// 计算抗滑稳定安全系数
        /// </summary>
        Task<double> CalculateSlidingStabilityAsync(
            DamEntity damEntity, 
            AnalysisParameters parameters);
        
        /// <summary>
        /// 计算抗倾覆稳定安全系数
        /// </summary>
        Task<double> CalculateOverturnStabilityAsync(
            DamEntity damEntity, 
            AnalysisParameters parameters);
        
        /// <summary>
        /// 评估综合稳定性状态
        /// </summary>
        StabilityStatus EvaluateOverallStability(
            StabilityAnalysisResult result);
    }
}
```

**2. IProfile2DAnalysisService - 二维剖面分析服务**

```csharp
namespace GravityDamAnalysis.Core.Services
{
    /// <summary>
    /// 二维剖面分析服务接口
    /// </summary>
    public interface IProfile2DAnalysisService
    {
        /// <summary>
        /// 从三维坝体提取二维剖面
        /// </summary>
        Task<List<Profile2D>> ExtractProfilesAsync(
            DamEntity damEntity, 
            List<SectionLocation> locations);
        
        /// <summary>
        /// 分析二维剖面稳定性
        /// </summary>
        Task<Profile2DStabilityResult> AnalyzeProfile2DStabilityAsync(
            Profile2D profile, 
            AnalysisParameters parameters);
        
        /// <summary>
        /// 批量分析多个剖面
        /// </summary>
        Task<BatchAnalysisResult> AnalyzeMultipleProfilesAsync(
            List<Profile2D> profiles, 
            AnalysisParameters parameters);
    }
}
```

### Calculation层：稳定性计算引擎

Calculation层实现了Core层定义的领域服务接口，包含具体的计算算法和业务逻辑。

#### 主要服务实现

**1. StabilityAnalysisService - 稳定性分析实现**

```csharp
namespace GravityDamAnalysis.Calculation.Services
{
    /// <summary>
    /// 稳定性分析服务实现
    /// 实现了Core层的IStabilityAnalysisService接口
    /// </summary>
    public class StabilityAnalysisService : IStabilityAnalysisService
    {
        private readonly ILogger<StabilityAnalysisService> _logger;
        private readonly ISlidingStabilityCalculator _slidingCalculator;
        private readonly IOverturnStabilityCalculator _overturnCalculator;
        
        public StabilityAnalysisService(
            ILogger<StabilityAnalysisService> logger,
            ISlidingStabilityCalculator slidingCalculator,
            IOverturnStabilityCalculator overturnCalculator)
        {
            _logger = logger;
            _slidingCalculator = slidingCalculator;
            _overturnCalculator = overturnCalculator;
        }
        
        public async Task<StabilityAnalysisResult> AnalyzeStabilityAsync(
            DamEntity damEntity, 
            AnalysisParameters parameters)
        {
            _logger.LogInformation("开始稳定性分析 - 坝体: {DamName}", damEntity.Name);
            
            var result = new StabilityAnalysisResult
            {
                DamEntityId = damEntity.Id,
                AnalysisParameters = parameters,
                CalculatedAt = DateTime.UtcNow
            };
            
            try
            {
                // 1. 抗滑稳定分析
                _logger.LogDebug("计算抗滑稳定性");
                result.SlidingStability = await _slidingCalculator
                    .CalculateAsync(damEntity, parameters);
                
                // 2. 抗倾覆稳定分析  
                _logger.LogDebug("计算抗倾覆稳定性");
                result.OverturnStability = await _overturnCalculator
                    .CalculateAsync(damEntity, parameters);
                
                // 3. 综合稳定性评估
                result.OverallStability = EvaluateOverallStability(result);
                
                _logger.LogInformation("稳定性分析完成 - 抗滑安全系数: {SlidingSF:F3}, " +
                    "抗倾覆安全系数: {OverturnSF:F3}", 
                    result.SlidingStability.SafetyFactor,
                    result.OverturnStability.SafetyFactor);
                
                return result;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "稳定性分析失败");
                throw new CalculationException("稳定性分析执行失败", ex);
            }
        }
    }
}
```

**2. Profile2DStabilityAnalyzer - 二维剖面分析器**

```csharp
namespace GravityDamAnalysis.Calculation.Services
{
    /// <summary>
    /// 二维剖面稳定性分析器
    /// 专门处理二维剖面的稳定性计算
    /// </summary>
    public class Profile2DStabilityAnalyzer : IProfile2DAnalysisService
    {
        private readonly ILogger<Profile2DStabilityAnalyzer> _logger;
        private readonly IGeometryAnalyzer _geometryAnalyzer;
        
        public async Task<Profile2DStabilityResult> AnalyzeProfile2DStabilityAsync(
            Profile2D profile, 
            AnalysisParameters parameters)
        {
            // 1. 几何特性分析
            var geometry = await _geometryAnalyzer.AnalyzeGeometryAsync(profile);
            
            // 2. 荷载分析
            var loads = CalculateLoads2D(geometry, parameters);
            
            // 3. 稳定性计算
            var slidingStability = CalculateSlidingStability2D(loads, parameters);
            var overturnStability = CalculateOverturnStability2D(geometry, loads);
            
            return new Profile2DStabilityResult
            {
                ProfileIndex = profile.Index,
                GeometryProperties = geometry,
                LoadAnalysis = loads,
                SlidingStability = slidingStability,
                OverturnStability = overturnStability,
                CalculatedAt = DateTime.UtcNow
            };
        }
        
        /// <summary>
        /// 计算二维荷载（单位坝轴长度）
        /// </summary>
        private Profile2DLoadAnalysis CalculateLoads2D(
            Profile2DGeometryProperties geometry, 
            AnalysisParameters parameters)
        {
            var loads = new Profile2DLoadAnalysis();
            
            // 自重（kN/m）
            loads.SelfWeight = geometry.Area * parameters.MaterialProperties.Density;
            
            // 净水压力（kN/m）
            loads.NetWaterPressure = CalculateNetWaterPressure2D(parameters);
            
            // 扬压力（kN/m）
            loads.UpliftForce = CalculateUpliftForce2D(geometry, parameters);
            
            // 地震惯性力（kN/m）
            loads.SeismicForce = parameters.SeismicCoefficient * loads.SelfWeight;
            
            // 有效法向力
            loads.EffectiveNormalForce = loads.SelfWeight - loads.UpliftForce;
            
            return loads;
        }
    }
}
```

### Infrastructure层：Revit数据提取

Infrastructure层负责与外部系统（主要是Revit）的交互，实现数据的提取和转换。

#### 数据提取服务

**1. RevitGeometryExtractor - Revit几何提取器**

```csharp
namespace GravityDamAnalysis.Infrastructure.Revit
{
    /// <summary>
    /// Revit几何数据提取器
    /// </summary>
    public class RevitGeometryExtractor : IGeometryExtractor
    {
        private readonly ILogger<RevitGeometryExtractor> _logger;
        private readonly Document _document;
        
        public RevitGeometryExtractor(ILogger<RevitGeometryExtractor> logger)
        {
            _logger = logger;
            _document = DocumentManager.Instance.CurrentDBDocument;
        }
        
        /// <summary>
        /// 从Revit元素提取坝体几何
        /// </summary>
        public async Task<DamGeometry> ExtractDamGeometryAsync(ElementId elementId)
        {
            var element = _document.GetElement(elementId);
            if (element == null)
                throw new InvalidOperationException($"未找到元素: {elementId}");
            
            using (var transaction = new Transaction(_document, "提取几何"))
            {
                transaction.Start();
                
                try
                {
                    // 获取几何选项
                    var options = new Options
                    {
                        ComputeReferences = true,
                        DetailLevel = ViewDetailLevel.Fine,
                        IncludeNonVisibleObjects = false
                    };
                    
                    // 提取几何体
                    var geometryElement = element.get_Geometry(options);
                    if (geometryElement == null)
                        throw new InvalidOperationException("无法获取元素几何");
                    
                    // 计算几何属性
                    var geometry = await CalculateGeometryPropertiesAsync(geometryElement);
                    
                    transaction.Commit();
                    
                    _logger.LogInformation("成功提取几何 - 高度: {Height:F2}m, " +
                        "底宽: {BaseWidth:F2}m, 体积: {Volume:F2}m³",
                        geometry.Height, geometry.BaseWidth, geometry.Volume);
                    
                    return geometry;
                }
                catch
                {
                    transaction.RollBack();
                    throw;
                }
            }
        }
        
        private async Task<DamGeometry> CalculateGeometryPropertiesAsync(
            GeometryElement geometryElement)
        {
            // 实现几何属性计算逻辑
            // 这里简化处理，实际需要复杂的几何分析
            
            var boundingBox = CalculateBoundingBox(geometryElement);
            var volume = CalculateVolume(geometryElement);
            var centroid = CalculateCentroid(geometryElement);
            
            return new DamGeometry
            {
                Height = boundingBox.Max.Z - boundingBox.Min.Z,
                BaseWidth = boundingBox.Max.X - boundingBox.Min.X,
                TopWidth = CalculateTopWidth(geometryElement),
                Length = boundingBox.Max.Y - boundingBox.Min.Y,
                Volume = volume,
                Centroid = centroid
            };
        }
    }
}
```

## 3.2.2 核心服务设计

### 依赖注入配置

```csharp
namespace GravityDamAnalysis.Revit
{
    /// <summary>
    /// 插件应用程序 - 配置依赖注入
    /// </summary>
    public class DamAnalysisApplication : IExternalApplication
    {
        private IServiceProvider _serviceProvider;
        
        public Result OnStartup(UIControlledApplication application)
        {
            try
            {
                // 配置依赖注入容器
                var services = new ServiceCollection();
                ConfigureServices(services);
                _serviceProvider = services.BuildServiceProvider();
                
                // 注册UI面板和命令
                RegisterRibbonPanels(application);
                RegisterCommands(application);
                
                return Result.Succeeded;
            }
            catch (Exception ex)
            {
                TaskDialog.Show("启动错误", $"插件启动失败: {ex.Message}");
                return Result.Failed;
            }
        }
        
        /// <summary>
        /// 配置依赖注入服务
        /// </summary>
        private void ConfigureServices(IServiceCollection services)
        {
            // 核心服务
            services.AddScoped<IStabilityAnalysisService, StabilityAnalysisService>();
            services.AddScoped<IProfile2DAnalysisService, Profile2DStabilityAnalyzer>();
            
            // 计算器
            services.AddScoped<ISlidingStabilityCalculator, SlidingStabilityCalculator>();
            services.AddScoped<IOverturnStabilityCalculator, OverturnStabilityCalculator>();
            
            // 基础设施服务
            services.AddScoped<IGeometryExtractor, RevitGeometryExtractor>();
            services.AddScoped<IDamIdentificationService, DamIdentificationService>();
            
            // 应用服务
            services.AddScoped<IDamAnalysisWorkflow, DamAnalysisWorkflow>();
            
            // 日志配置
            services.AddLogging(builder =>
            {
                builder.AddSerilog(Log.Logger);
            });
            
            // 配置选项
            services.Configure<AnalysisSettings>(options =>
            {
                options.DefaultFrictionCoefficient = 0.75;
                options.DefaultUpliftReductionFactor = 0.8;
                options.MinSlidingSafetyFactor = 3.0;
                options.MinOverturnSafetyFactor = 1.5;
            });
        }
    }
}
```

### 工作流服务设计

```csharp
namespace GravityDamAnalysis.Application.Workflows
{
    /// <summary>
    /// 坝体分析工作流 - 协调各个服务
    /// </summary>
    public class DamAnalysisWorkflow : IDamAnalysisWorkflow
    {
        private readonly IStabilityAnalysisService _stabilityService;
        private readonly IProfile2DAnalysisService _profileService;
        private readonly IGeometryExtractor _geometryExtractor;
        private readonly ILogger<DamAnalysisWorkflow> _logger;
        
        public async Task<WorkflowResult> ExecuteCompleteAnalysisAsync(
            ElementId damElementId,
            AnalysisParameters parameters)
        {
            var result = new WorkflowResult { StartTime = DateTime.UtcNow };
            
            try
            {
                // 1. 提取坝体几何
                _logger.LogInformation("开始提取坝体几何");
                var geometry = await _geometryExtractor
                    .ExtractDamGeometryAsync(damElementId);
                
                // 2. 创建坝体实体
                var damEntity = DamEntity.Create(
                    $"Dam_{damElementId.IntegerValue}",
                    geometry,
                    parameters.MaterialProperties);
                
                // 3. 执行稳定性分析
                _logger.LogInformation("开始稳定性分析");
                var stabilityResult = await _stabilityService
                    .AnalyzeStabilityAsync(damEntity, parameters);
                
                // 4. 如果需要，执行二维剖面分析
                if (parameters.EnableProfile2DAnalysis)
                {
                    _logger.LogInformation("开始二维剖面分析");
                    var profiles = await _profileService
                        .ExtractProfilesAsync(damEntity, parameters.SectionLocations);
                    
                    var profileResults = await _profileService
                        .AnalyzeMultipleProfilesAsync(profiles, parameters);
                    
                    result.ProfileAnalysisResults = profileResults;
                }
                
                result.StabilityResult = stabilityResult;
                result.IsSuccessful = true;
                result.EndTime = DateTime.UtcNow;
                
                _logger.LogInformation("分析工作流完成，用时: {Duration:F2}s",
                    result.Duration.TotalSeconds);
                
                return result;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "分析工作流执行失败");
                result.IsSuccessful = false;
                result.ErrorMessage = ex.Message;
                result.EndTime = DateTime.UtcNow;
                return result;
            }
        }
    }
}
```

---

## 本节小结

本节介绍了重力坝稳定计算插件的分层架构设计，主要内容包括：

1. **分层架构**：Core、Calculation、Infrastructure、Application、Revit五层架构
2. **核心实体**：DamEntity、Profile2D等领域对象的设计
3. **服务接口**：稳定性分析和剖面分析的服务接口定义
4. **依赖注入**：服务容器配置和依赖关系管理
5. **工作流设计**：完整分析流程的协调机制

这种架构设计的优势：
- **职责分离**：每层有明确的职责边界
- **可测试性**：通过依赖注入便于单元测试
- **可扩展性**：新增功能时遵循开闭原则
- **可维护性**：代码结构清晰，便于维护

下一节将介绍核心算法的具体实现。
